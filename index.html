<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Harbor by adrianpike</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Harbor</h1>
        <p>Harbor is a set of tools and services for microservice deployment.</p>

        <p class="view"><a href="https://github.com/adrianpike/harbor">View the Project on GitHub <small>adrianpike/harbor</small></a></p>


        <ul>
          <li><a href="https://github.com/adrianpike/harbor/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/adrianpike/harbor/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/adrianpike/harbor">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="harbor" class="anchor" href="#harbor" aria-hidden="true"><span class="octicon octicon-link"></span></a>harbor</h1>

<p>Harbor is a routing layer and set of deployment tools for
<a href="http://12factor.net">12factor</a> microservice infrastructures. It allows
engineering teams to easily deploy releases onto production infrastructure
without downtime, and cut traffic over to individual services at their leisure.</p>

<p>It's designed to be modular and pluggable - if you want to run your own PaaS,
harbor will do that. If you want to run your services on Heroku, harbor
will help with the coordination of that as well.</p>

<p>In short, as an engineer, it makes life as simple as this;</p>

<div class="highlight highlight-bash"><pre>adrian$ harbor deploy
<span class="pl-c"># Harbor firing a deploy for "Thunderchicken"</span>
<span class="pl-c"># - Thunderchicken#backend-service-1 has new revision, spawning on prod-1.foobarapp.com</span>
<span class="pl-c"># - Thunderchicken#backend-service-1#c211f listening on port 4921</span>
<span class="pl-c"># - New build `020864f02d7c4c832aca7d204ca9b9cd59934287` released</span>
adrian$ harbor route production 020864f02d7c4c832aca7d204ca9b9cd59934287
<span class="pl-c"># Harbor routing production traffic to 020864f02d7c4c832aca7d204ca9b9cd59934287</span>
<span class="pl-c"># - Thunderchicken#backend-service-1#a3321 is orphaned and can reaped from all hosts.</span></pre></div>

<p>A lot just happened - I committed some changes to <code>backend-service-1</code>, and
released a new build of our entire app. Anything other than <code>backend-service-1</code>
was untouched, and no traffic touched the new revision until I asked to move
traffic over.</p>

<p>If you want to jump right in, install the <a href="http://adrianpike.github.com/harbor-cli">harbor_cli</a>
gem, and run <code>harbor init</code>. It'll walk you through what you need.</p>

<p>Under the hood, here's what's happening;</p>

<ul>
<li>I requested a deploy, and a Harborfile was read, to determine
all the services that make up this app and understand a little about my
deployment environment.</li>
<li>My local Git SHAs were compared against running SHAs across the entire
collection of Harbor servers.</li>
<li>A new SHA was discovered, a Harbor server was selected to deploy to, and a
new process was spawned on that server running the newest code for that
service.</li>
<li>Any DNS references to internal services were updated to point to the correct
revisions in the code I just deployed for <code>backend-service-1</code>.</li>
<li>A <code>build</code> was determined, which is a collection of service SHAs to consider
as one running build.</li>
<li>All the build, service, and revision hosts, ports and SHAs were updated in
our port registry.</li>
<li>I flipped production traffic over to that latest <code>build</code>, and traffic began
to flow to the new revision of <code>backend-service-1</code>, and since I didn't bump
any other services, everything else remained.</li>
</ul>

<h2>
<a id="quickstart" class="anchor" href="#quickstart" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quickstart</h2>

<pre lang="blockquote"><code>Please note, as of March 3rd, 2015, Harbor is under active development and
should be used with care. Things will be shifting around underneath you in
the next few weeks, it's untested.

With that said, it _is_ currently handling production traffic for a handful
of sites.
</code></pre>

<p>There's some important assumptions we'll make out of the gate.</p>

<ul>
<li>You're using git as your VCS. There are no plans at this time to support others.</li>
<li>You've got more than one service. Otherwise, just use Heroku, life will be easier!</li>
<li>You're using HTTP to communicate between services.</li>
<li>Services listen on a $PORT environment variable, and we've decided on some
unique ports to use for inter-service communication and development.</li>
</ul>

<pre><code>As of March 2nd, 2015 the only way to host apps is through the native harbord.
The next hosting layer to be supported is Heroku.
</code></pre>

<h3>
<a id="harbord-setup" class="anchor" href="#harbord-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>harbord Setup</h3>

<p>1) Clone <a href="http://github.com/adrianpike/harbor">harbor</a> (this repo) somewhere
on the server(s) you want to deploy to.</p>

<p>2) <code>npm install</code></p>

<p>3) Edit <code>etc/config.json</code> to point to a shared Redis instance for persistent
storage.</p>

<p>4) Run <code>bin/harbord</code></p>

<p>5) Ensure your control port (default 6060) is closed off to public traffic.
The Harbor CLI uses SSH tunneling for its access.</p>

<h3>
<a id="client-setup" class="anchor" href="#client-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Client Setup</h3>

<p>1) Install <a href="http://github.com/adrianpike/harbor_cli">harbor_cli</a>. Then come back here.</p>

<p>2) Initialize your Harborfile with <code>harbor init</code>. Follow the prompts.</p>

<div class="highlight highlight-bash"><pre>adrian$ <span class="pl-s3">cd</span> src/my_amazing_project/
adrian$ harbor init
Starting Harborfile generated from your Procfile. You should review and edit it.
<span class="pl-c">##### Finishing Up #####</span>
1. Any places where you<span class="pl-s1"><span class="pl-pds">'</span>re referencing external services need to be changed to</span>
<span class="pl-s1">   the .harbor suffix. Please see http://adrianpike.github.io/harbor/ for more</span>
<span class="pl-s1">   information.</span>
<span class="pl-s1">2. You need to set up local DNS to resolve .harbor to 127.0.0.1.</span>
<span class="pl-s1">3. Use Foreman as usual.</span></pre></div>

<p>3) Ensure you're set up for passwordless SSH to any hosts you want to deploy to.</p>

<p>You're ready to go! If you want to dive in, start playing with the Harbor CLI.
If you want to learn more about what's happening, read on.</p>

<h2>
<a id="about-harbor" class="anchor" href="#about-harbor" aria-hidden="true"><span class="octicon octicon-link"></span></a>About Harbor</h2>

<h3>
<a id="a-service" class="anchor" href="#a-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>A Service</h3>

<p>A Service is a single <a href="http://12factor.net">12factor</a> service which is a component of a larger
application. Services are given dynamic ports via the PORT environment variable.
A service listens on this port for HTTP traffic, and has traffic routed to it
via the <code>Routing Layer</code>.</p>

<h3>
<a id="the-build-step" class="anchor" href="#the-build-step" aria-hidden="true"><span class="octicon octicon-link"></span></a>The build step</h3>

<pre><code>The build process is within the CLI, and is currently in flux to move to Heroku
buildpacks.
</code></pre>

<h3>
<a id="the-routing-layer" class="anchor" href="#the-routing-layer" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Routing Layer</h3>

<p>The routing layer is how HTTP traffic is routed to the correct instance of a
service. The lifecycle of an HTTP request can be complicated as it moves
through the appropriate versioning systems.</p>

<ul>
<li>TCP Port - [Service] -&gt; Service Name</li>
<li>Domain - [Route] -&gt; Deploy/Release SHA</li>
<li>Deploy/Release SHA - [Deploy] -&gt; Service SHA</li>
<li>Service SHA - [Port Registry] -&gt; Instance</li>
</ul>

<h3>
<a id="service-versioning" class="anchor" href="#service-versioning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Service Versioning</h3>

<pre><code>Service versioning is currently in flux.
</code></pre>

<h3>
<a id="the-harborfile" class="anchor" href="#the-harborfile" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Harborfile</h3>

<p>The Harborfile is how the CLI is configured. It specifies what your services
are, where they can be found locally, what deploy method(s) you're using, and
anything else that might need to be configured. You shouldn't be creating your
Harborfile from scratch though - the CLI has the <code>harbor init</code> command to walk
you through it and auto-discover what it can.</p>

<p>An example is below;</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s1"><span class="pl-ent">services:</span></span>
  <span class="pl-s1"><span class="pl-ent">web:</span></span>
    <span class="pl-c1"><span class="pl-ent">port:</span> 80</span>
    <span class="pl-s1"><span class="pl-ent">cmd:</span> <span class="pl-s1">bundle exec unicorn -p $PORT -c ./config/unicorn.rb</span></span>
    <span class="pl-s1"><span class="pl-ent">path:</span> <span class="pl-s1">./</span></span>
  <span class="pl-s1"><span class="pl-ent">cuckoo:</span></span>
    <span class="pl-c1"><span class="pl-ent">port:</span> 6060</span>
    <span class="pl-s1"><span class="pl-ent">cmd:</span> <span class="pl-s1">supervisor -w cuckoo -- ./cuckoo/cuckoo.coffee</span></span>
    <span class="pl-s1"><span class="pl-ent">path:</span> <span class="pl-s1">../cuckoo</span></span>
  <span class="pl-s1"><span class="pl-ent">arterial:</span></span>
    <span class="pl-c1"><span class="pl-ent">port:</span> 5252</span>
    <span class="pl-s1"><span class="pl-ent">cmd:</span> <span class="pl-s1">supervisor -w arterial -- ./arterial/lib/server.coffee</span></span>
    <span class="pl-s1"><span class="pl-ent">path:</span> <span class="pl-s1">../arterial</span></span>
<span class="pl-s1"><span class="pl-ent">harbor:</span></span>
  <span class="pl-s1"><span class="pl-ent">app:</span> <span class="pl-s1">elapse</span></span>
  <span class="pl-s1"><span class="pl-ent">deploy_dir:</span> <span class="pl-s1"><span class="pl-pds">'</span>/home/apps/deploys<span class="pl-pds">'</span></span></span>
  <span class="pl-s1"><span class="pl-ent">deploy_user:</span> <span class="pl-s1">apps</span></span>
  <span class="pl-s1"><span class="pl-ent">servers:</span></span>
    <span class="pl-s1">- <span class="pl-ent">type:</span> <span class="pl-s1">http+ssh</span></span>
      <span class="pl-s1"><span class="pl-ent">host:</span> <span class="pl-s1">sea1.adrianpike.com</span></span></pre></div>

<h2>
<a id="immediate-todo" class="anchor" href="#immediate-todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Immediate TODO</h2>

<p>Prerelease</p>

<ul>
<li>Use Heroku buildpacks correctly in the CLI</li>
<li>Development mode</li>
<li><p>Persistent services</p></li>
<li><p>Harbord namespaced per application (v0)</p></li>
<li>
<p>Backend hosting layers</p>

<ul>
<li>Heroku (v1)</li>
<li>Native method (v0)</li>
</ul>
</li>
<li>
<p>Routing layers</p>

<ul>
<li>Native (v1)</li>
<li>Direct DNS (icebox)</li>
<li>offload to a haproxy (v2)</li>
</ul>
</li>
<li>
<p>Inter-process routing method</p>

<ul>
<li>Multiple instances of Upstream services (v2)</li>
<li>Header passing through magic (v1)</li>
</ul>
</li>
<li>
<p>Persistence Backend layers</p>

<ul>
<li>Redis (v1)</li>
<li>etcd (v2)</li>
<li>consul (v2)</li>
</ul>
</li>
<li>
<p>Logging layers</p>

<ul>
<li>capture to files (v1)</li>
</ul>
</li>
<li>
<p>Metrics layers (v2)</p>

<ul>
<li>statsd</li>
<li>stdout</li>
<li>graphite</li>
</ul>
</li>
</ul>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/adrianpike">adrianpike</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>